import type { Browser as PuppeteerBrowser } from "puppeteer";
import { afterAll, beforeAll, describe, expect, it, vi } from "vitest";
import { lpeSource as config } from "@/config/sources/lpe.js";
import { createBrowser, setupPage } from "@/crawlers/browser";
import { createContentPageExtractor } from "@/crawlers/extractors/ContentPageExtractor";
import { createListingPageExtractor } from "@/crawlers/extractors/ListingPageExtractor";

const ifDescribe = process.env.INT_TEST === "true" ? describe : describe.skip;

ifDescribe("Logos integration tests", () => {
	let browser: PuppeteerBrowser;
	vi.setConfig({ testTimeout: 60000 });

	beforeAll(async () => {
		browser = await createBrowser();
	});

	afterAll(async () => {
		await browser.close();
	});

	it("should crawl LPE listing page", async () => {
		const page = await setupPage(browser, config.listing.url);
		const extractor = createListingPageExtractor();
		const result = await extractor.extractItemsFromPage(page, config, [], 0);
		console.log(result.items);
		expect(result.items.length).toBeGreaterThan(0);
		expect(result.items.every((item) => !!item.title)).toBeTruthy();
		expect(result.items.every((item) => !!item.url)).toBeTruthy();
		expect(result.items.every((item) => !!item.publishedDate)).toBeTruthy();
	});

	// Logos Press Engine has only 1 page for now
	/* it("should crawl to next LPE listing page", async () => {
		const page = await setupPage(browser, config.listing.url);
		expect(await navigateToNextPage(page, config)).toBeTruthy();
	}); */

	it("should crawl multiple LPE content pages", async () => {
		const testCases = [
			{
				url: "https://press.logos.co/article/august-2025",
				expectedTitle: "State of the Logos Network: August 2025",
				expectedAuthor: "Logos",
				expectedContent:
					"Cultivating communityLogos is a movement committed to reshaping how people come together and organise. Achieving this vision depends on the dedication of an engaged, motivated community. If our principles resonate with you, we invite you to contribute your skills and creativity. We recognise and support those who choose to build with us.We’ve just launched a community contributions portal, which makes it easy to submit proposals to make technical and non-technical contributions to Logos (including writing for Logos Press Engine). Check out the Logos Contribute portal and start contributing to the Logos movement today!LearningFarewell to WestphaliaWe’re thrilled to reveal that Farewell to Westphalia, coauthored by Logos cofounder Jarrad Hope and author of Crypto Anarchy, Cyberstates, and Pirate Utopias, Peter Ludlow, will be available in paperback, ereader edition, and as a free download on 16 September.The book presents blockchain technology as infrastructure for a peaceful revolution in the way we organise and cooperate. It opens with a critique of the current nation-state system, arguing that new global issues are forcing nations to cede sovereignty to non-state entities. It then makes the case for blockchain’s potential to bring transparency, efficiency, and accountability to all levels of governance. Learn more. Preorders for the ereader edition are live now. If you own a Kindle and are interested in the book’s ideas, please consider preordering – it will really help boost the book’s chart position, exposing it to more people who may find value in its content.As 16 September approaches, we’re ramping up promotional activities, including appearances by the authors on relevant podcasts, like the one below. We’re also appealing to the Logos community to help us get Farewell to Westphalia into legacy education institutions. If you have relevant contacts from universities or libraries, or if you know of any appropriate bookshops that might want to stock the book, please email pressengine@logos.co.Logos Press EngineWe’re thrilled to see more community members contributing to Logos Press Engine. We’re currently working with two contributors to publish their writing. They’ll be available to read on the LPE very soon. Thanks for the submissions, JosiahWarren and Severoni! If you have something to add to the alternative governance conversation, why not submit a Logos Press Engine article proposal? Head to the new Logos Contribute portal to start contributing to Logos Press Engine.X Spaces Logos hosts regular X Spaces with those at the forefront of governance and technological innovation. August’s Spaces tackled such topics as stablecoins, CBDCs, cognitive sovereignty, free media, and freethinking in cyberstates and blockchain communities, with widely known speakers in the liberty space and the crypto community. Guests included entrepreneur, investor, and activist Aaron Day, Jason Bassler and Matt Savoy from the Free Thought Project, and cognitive scientist Anna Riedl.Follow Logos on X to listen in and join these fascinating discussions every Thursday. Logos IRLLogos CirclesLogos Circles are regular meetups held in various hubs around the world and in cyberspace. Their aim is to expand the Logos community and identify issues that Logos technologies and grassroots collective action can address. Last month, a new Circle formed – Logos Circle: Los Angeles. Hosted at the Arts District Brewing Company, the event was attended by a good mix of developers and non-developers. Alongside conversations about Logos and our goals, we were delighted to see one attendee dive right into Waku, spinning up an nwaku node and praising the project’s documentation. We also started a book-sharing initiative, with five copies of Farewell to Westphalia loaned out, and those receiving it asked to write a message in the cover for its next recipient. Read more about Logos Circle: Los Angeles and stay tuned for more information about the next LA Circle via Discord and the Logos X account.In August, Logos Circle: Lisbon connected with the community of Quinta do Mocho, a public housing neighbourhood with a strong African diasporic identity and vibrant underground culture. We explored opportunities to collaborate on a creative hub, Parallel Society side events, and integrating local freelancers into the Talude decentralised marketplace.The next Lisbon Circle will be held at the Well Read book shop again on 1 October. More information. Logos Circle: Zanzalu moved forward with its initiative to supply the Straight Learning Center in Zanzibar with the computing equipment mentioned in last month’s State of the Logos Network. Ten Raspberry Pis were delivered to the school this week, and all further donations will go toward securing one month’s rent payment for this fantastic educational initiative. If you have something to spare, donate now.Barcelona is about to become the latest city to play host to a Logos Circle. We’re inviting local cypherpunks, technologists, artists, journalists, activists, charities, and anyone interested in rebuilding civil society in the area to join us at the AKASHA Hub on 9 September. Expect an evening of discussions, collaboration, and planning grassroots solutions to issues facing residents of the Catalan capital. More information and register your interest. This month will also see the return of Logos Circle: Brno, which will be held at the Pivnice U Tygra gastropub on 11 September. If you're in the area, head over to meet like-minded people committed to leveraging technologies to defend our liberties. Learn more and register.In addition to Logos Circle: Barcelona, a new Logos Circle will form in the Nigerian city of Benin on 12 September. Hosted at the Magnitron Blockchain Solution & Academy, we invite anyone interested in our principles and applying our technologies to winnable, local issues to join the event. Learn more and register.Logos Circle: Online is a regular meetup held on X Spaces. The events, held every Tuesday, have brought Circle founders from LA, London, and Africa together to discuss progress toward solving winnable issues in their local communities. Our online circle has grown significantly in the two months since launching the initiative, showing that those in the community and beyond are excited by our movement and building a real community around it. Alongside regular updates from IRL Circles, we’ve discussed Farewell to Westphalia, the meaning crisis, left versus right paradigm, political identity, token-economic models, and more.Follow Logos on X and join the next Logos Circle: Online this coming Tuesday.Parallel Society We’re thrilled to reveal the date for next year’s Parallel Society: 6–7 March 2026, in Lisbon, Portugal. The event is an international, multi-site convergence of internet pioneers, open-source innovators, underground movements, experimental governance, and bold new cultural imagination.Parallel Society is more than a festival; it’s a countercultural gathering – a collectively organised, living ecosystem where music, art, and technology intersect. Rooted in innovation, autonomy, and the underground spirit, it is a space for creativity without boundaries. The not-for-profit event will be run by and for the community around it.After the success of Parallel Society Congress in 2024, we’re doubling down on cultural components for next year’s Parallel Society.Community shoutoutsLike any movement, Logos exists and grows through the dedication of its community. If contributing to a better future inspires you, we’d be glad to have you on board.Every month, we highlight individuals who make an exceptional impact, whether by advancing Logos’ technology or strengthening the wider movement.In August, we celebrated:Looking to be featured in a community spotlight? Contribute something meaningful to our mission via the Logos Contribute portal. If you’d like input on a project you’re developing, post it on the Logos Forum and share the link in Discord to connect with others who can support it.Technology developmentWakuWaku’s August monthly update provides a more detailed account of the team’s recent progress. If you’re a developer, get involved and build Waku with us. CodexCodex’s August monthly update provides a more detailed account of the team’s recent progress. If you’re a developer, get involved and build Codex with us. NomosNomos’ August monthly update provides a more detailed account of the team’s recent progress. If you’re a developer, get involved and build Nomos with us. We see the rise of blockchain-based governance as inevitable and need developers, designers, writers, and all forward-thinkers who care about new governance models to help us shape what comes next. Contribute to our open-source projects on GitHub, craft and share our vision on socials, or join the conversation on Discord. Be part of the next wave of governance innovation now.",
			},
			{
				url: "https://press.logos.co/article/logos-a-declaration-of-independence-in-cyberspace",
				expectedTitle: "Logos: A Declaration of Independence in Cyberspace",
				expectedAuthor: "Logos",
				expectedContent:
					"Every once in a while a revolutionary idea appears that alters the fabric of our societies. The accompanying behaviours and technologies do not occur by chance; they are the aggregation of ancient trends and the inventiveness of millions. Language, agriculture, parliaments, the printing press, networked computing, blockchains, and artificial intelligence all transformed our world forever, rearranging human societies with a vision for the future. Today, we are bringing forth such a vision.In a world in which our lives are increasingly digital and borderless, the bureaucratic institutions of the state have been left behind, incapable of providing a peaceful order. The Westphalian system that birthed the nation state is struggling to keep up with a multi-polar, interconnected world. In this paradigm shift, the supra-national global elite is cannibalising its citizens and the fiat monetary system is collapsing in real time.We see this as the terminal phase of the Western project, a time of debt slavery, war, displacement, manipulation, corruption, broken ecosystems, widespread surveillance, nihilist values, socialised impoverishment, and bipartisan tyranny. Across the world, we are sleepwalking into a series of interdependent catastrophes, the likes of which have not been witnessed in generations. While most believe the situation is hopeless, we know it is not.To prove it, we are declaring independence from this dying order, reopening the frontier and establishing Logos, a self-sovereign network state founded on the solid ground of liberty, security, privacy, openness, and decentralisation. Logos is the ancient Greek concept for the connection between language, reason, and the order of the universe. To us, it represents a group of thinkers and builders searching for this immanent truth through dialogue, forming a global nation of shared values and like-minded peers.Our vision is to harness the transformational power of discovering together, building on our deep urge to invent and imagine a world beyond the tyrannical structures of the decaying status quo. Our mission is neither optional nor guided by chance, it is born out of necessity. We are at the critical juncture where the old system meets the new tools built to replace it, and we see no choice but to use them for our collective liberation. We know success is inevitable.We offer those who join us a liberated territory in cyberspace to interact freely in a passionate and respectful manner. To achieve this independence of the mind and body, we are building a versatile and powerful toolkit. The magic of cryptography gives us privacy, while the resilience of blockchains allows for global, coordinated, coercion-resistant institutions.These cutting-edge tools are designed to safeguard our basic rights, giving our citizens ownership of these technologies, a voice in their governance, and the opportunity to make a difference. We offer meaning in a world starved of it. We were there at the beginning, when Bitcoin proved this dream was possible. We share its ethos and extend its properties to a user-owned, self-sovereign network state.Doing this requires taking on the challenge set in the initial vision for Ethereum: a fully decentralised politically neutral tech stack complete with p2p communications, file storage, and a multi-chain ecosystem.On top of this infrastructure we are establishing a parallel society with voluntary, consensus based governing services, designed for plurality and hard-coded to respect fundamental human rights. This society is governed by a common law court system and a culture of virtues: wisdom, courage, humanity, justice, temperance, and transcendence.Logos is the next step forward in the evolution of crypto and traces its origins to the founding ideals of the cypherpunk movement. Bitcoin provides single use-case value transactions, Ethereum generalises this for arbitrary functions on a consensus layer, and Logos allows the deployment of arbitrary social institutions while adding network and transaction-level privacy.What does a world where we succeed look like? What will daily life be like in the network state and how do we solve the problems our citizens face?In our world, your life is as private as you want it to be. We are not the first to argue that privacy is necessary for an open society in the electronic age. Privacy is not secrecy, it is a fundamental right.In our world, you own the services you use, no matter if you drive a taxi, start companies, or organise politically. You own your information, your apps, your marketplaces, and your assets. This means a voice in their governance and a stake in their success.In our world, the rule of law is transparent, fair, and the true basis of our wealth. Our accessible governance system means transactions cost a fraction of what they do in the captured legacy bureaucracy, and that courts are trustworthy and mediation is minimal.In our world we have a transparent, self-sovereign monetary policy that serves the interests of our citizens.In our world assets are sovereign and secure, protected legally and technologically from outside and within. Logos is a digital Switzerland of the electronic age.In our world culture is free, forkable, and open. Freedom of expression is guaranteed by our underlying technology. If you do not agree with what you have consented to, you are always free to leave or remix.In our world hegemony is replaced by a plurality of heterogeneous communities, sharing a culture of voluntary consent. Hegemony is not only oppressive but inefficient, stifling creativity and limiting the potential for discovery. Logos is the next step in the evolution of society, from warlike and poverty-stricken barbarism to a prosperous civilisation of voluntary harmony.In our world the answers will not come from one person, one institution, or one group. We believe the smallest minority is the individual, and no individual is untouched by the experience, cultures, and relations they are party to. Hence we enable plurality instead of tolerating or censoring it.In our world people are not atomised and treated as machines, because people, not machines, are at the centre of what we envision.Our world is anonymous and non-elitist.We do not care who you are.We do not care about your gender, race, or nationality.We judge ideas on their merit and value through dialogue.We are people-powered software and we are relevant because of our uncompromising beliefs.We are bringing about the second enlightenment of the digital world, because the internet was not built for totalitarian control but for prosperity and emancipation.We also believe no one is free until we are all free, because no one is an island — we are all pieces of the main.We know there is going to be a pushback on what we create, but the reward is a freedom nobody has ever felt before.We will stop only when anybody, anywhere, can experience it.",
			},
			{
				url: "https://press.logos.co/article/keycard-manifesto",
				expectedTitle: "We Need Sovereign Tools: A Keycard Manifesto",
				expectedAuthor: "Guy-Louis Grau",
				expectedContent:
					"Self-custody offers a response. It is not only about securing assets but about enabling people to participate in networks and digital communities on their own terms. It is the foundation of digital sovereignty, and without it, no decentralised governance model can offer meaningful guarantees of autonomy. Tools that support self-custody must therefore be transparent, resilient, and open – available to all and owned by no one.Why self-custody needs to be reclaimedTechnically speaking, storing keys on a mobile phone or desktop computer does qualify as self-custody. The user holds their private keys, often in a locally stored keystore or encrypted vault. But these platforms are inherently vulnerable: they are connected to the Internet, regularly run untrusted code, and are exposed to a wide array of attack vectors. While convenient, they offer a weak guarantee of operational security and lack the focused protection that dedicated hardware can provide.Hardware wallets attempt to fill this gap. They isolate the keys from the broader software environment, limit communication interfaces, and use hardened hardware. But most current implementations have significant flaws that limit their reliability, trustworthiness, and interoperability:First, many are not fully open source. Without public code and schematics, it is impossible to independently audit their behaviour or verify their integrity. Second, their architectures are frequently opaque. While they include a secure element, the actual signing operation often takes place on a less secure microcontroller. This breaks the chain of trust that the secure element is supposed to guarantee.Third, they impose vendor-specific applications at least for setup and settings. This locks users into a proprietary ecosystem that may not align with their values or privacy expectations. Fourth, they rely on custom APIs that are incompatible with each other, fragmenting support across wallets and DApps.Fifth, their physical design introduces fragility. Devices often rely on internal batteries or soldered components. When a battery dies, the device is effectively unusable, even if the secure element is intact. Finally, and most importantly, the user’s private keys are tightly bound to the device and can’t be used with any other device. Also, if the part of the firmware accessing private keys is remotely upgradable, the rules for how those keys are used can be changed remotely, either by the vendor or under external pressure. In such a system, the user’s autonomy is conditional.We envision a different world: one where you use your keys across any hardware or software wallet, mobile or desktop device, payment system or DApp – your keys, your rules.A new paradigm: Breaking the hardware wallet monolithThe traditional hardware wallet model is monolithic: a single device handles key storage, signing, interface, and logic. By separating these roles, systems can become more secure, flexible, and composable.In this architecture, the secure element does one thing: it holds private keys and performs cryptographic signatures. It is minimal, isolated, and designed to resist both physical and logical attacks. User interfaces – screens, keyboards, QR readers – are modular and interchangeable. Communication happens over standard, inspectable channels like QR codes or NFC. The result is a clearer threat model, greater modularity, and more resilient design.Smart cards, and particularly JavaCards, are a mature and elegant solution for the secure element role. These cards are already used by billions of people in banking and telecommunication, and their security certifications (often EAL6+) reflect a high degree of confidence. JavaCard is one of the few secure element platforms that supports open development. Developers can write, publish, and audit applets that run on the card. Multiple vendors produce compatible cards, ensuring supply diversity.Another key advantage of JavaCards is their native NFC capability. A card can be tapped against a smartphone or terminal to sign a transaction – no pairing, no drivers, no complexity. This makes JavaCards uniquely suited for mobile crypto usage and for integration into broader systems like payment terminals, identity checkpoints, and physical access controls.They are also extremely practical. They contain no batteries, are immune to data loss due to power failure, and can last over 20 years. Physically, they are compact, water-resistant, and durable. They require no maintenance and cost just a few dollars. They are discreet, interoperable, and robust – a fitting platform for long-term key custody.Building blocks for sovereign hardwareKeycard is a fully open-source JavaCard applet that turns an ordinary smartcard into a secure signing device. It stores private keys, enforces PIN protection, and performs cryptographic operations. It is minimal by design.Shell is a modular, open-source hardware wallet that uses Keycard as its secure element. It includes a screen, keyboard, camera, and power source, but never accesses the private key directly. It reads transactions via QR codes or USB, displays them clearly on-screen, and then prompts Keycard to sign them securely. Shell supports QR standards such as ERC-4527 and UR2.0, allowing smooth integration with many existing wallets across both EVM-compatible chains and Bitcoin.Shell is fully open source (from software to hardware and casing), under a permissive MIT license, and its design is offered as a gift to the community – an open reference design to demonstrate how hardware wallets can evolve. It is not meant to lock users into a new ecosystem, but rather to inspire forks, adaptations, and improvements. It is a tool to advance best practices in the hardware wallet space and to encourage better architectures that reflect the principles of transparency, portability, and autonomy.Together, Keycard and Shell provide a secure, modular foundation for self-custody that any project or user can adopt. They are public goods: freely available, community-owned, and built for integration.A community-centric modelA modular, permissionless hardware stack only makes sense if anyone can build on it. That is why we are nurturing a community of self-custody enthusiasts: security researchers, web3 builders, privacy advocates, hardware tinkerers, and software wallet developers.This community already exists. Many projects are already building on Keycard. We invite manufacturers to produce their own JavaCard variants. We invite projects to adopt the Keycard API. We invite hardware and software wallets to integrate with it, browser wallets to support it, and payment systems to accept it.This project is for anyone who believes users should control their own keys securely and across any device. The goal is to grow an open ecosystem that serves real users, expands what’s possible, and reflects the values of self-custody.The Keycard API is the core of this vision. It’s a simple, shared interface that enables hardware and software to work together. It’s not controlled by anyone. It’s a common good – open, minimal, and reliable.To encourage trust without central gatekeepers, we support the formation of a card alliance: an open registry where card manufacturers can publish their certificate authorities. Anyone can check where a card comes from – no approvals needed.Imagine the world this unlocks: users carry their secure element, in the form of a card, and use it wherever they like. They tap to sign on mobile, scan QR codes with a Shell-like device, insert their card into a USB reader for desktop use, or perform transactions with a tap at payment terminals. Even existing hardware wallets with NFC, like Ledger or Coldcard, could offer card-based signing as an option on top of their current scheme.In the future we’re aiming towards, users themselves can truly own, build, and verify the secure element they want to use with their software or hardware wallets. JavaCards allow just that: they can be purchased blank, programmed with a trusted applet like the Keycard applet, and locked to prevent further changes.Why it matters for LogosLogos is not just a stack of technologies – it is an invitation to form decentralised, self-sovereign communities. These communities rely on cryptographic tools to coordinate, govern, and transact. But such coordination is only as strong as the keys that secure it. Without user-controlled private keys, no Logos application can offer true autonomy.Keycard provides a solution to this. It enables citizens of a network state to hold their own keys, participate in their own governance, and access their own data, without asking permission from any intermediary.Beyond function, Keycard can act as a symbol of belonging. In any community, physical tokens reinforce identity. A Keycard can be designed to reflect a specific network state’s culture, values, or membership. It can be used as an access credential, a voting token, or a governance tool. It becomes a badge not just of access, but of alignment.Combined with Shell or used with a smartphone, Keycard offers a secure, intuitive gateway to all of Logos’ services. If integrated with Nomos, Waku, or Codex nodes, it can also serve as a hardware secure module that secures the infrastructure itself. It’s not just a tool for users – it’s a trust anchor for the entire ecosystem.In closingSelf-custody is the cornerstone of digital freedom. Tools that facilitate it must be open, secure, and simple to use. Keycard and Shell embody these principles, not as products to be owned, but as public goods to be shared.The future of digital sovereignty depends on infrastructures that anyone can use, fork, extend, and trust. These tools are a small part of that larger vision. They are available now. They are free. They are yours.If you believe in such a vision, you are already part of it.Join the Logos community, preorder Keycard Shell, and help us build Keycard together.",
			},
		];

		await Promise.all(
			testCases.map(async (testCase) => {
				const page = await setupPage(browser, testCase.url);
				const extractor = createContentPageExtractor();
				const result = await extractor.extractFromContentPage(
					page,
					testCase.url,
					config,
				);

				expect(result.contentData.title).toEqual(testCase.expectedTitle);
				expect(result.contentData.author).toEqual(testCase.expectedAuthor);
				expect(result.contentData.content).toEqual(testCase.expectedContent);
				expect(result.errors.length).toBe(0);

				await page.close();
			}),
		);
	});
});
