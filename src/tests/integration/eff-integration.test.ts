import type { Browser as PuppeteerBrowser } from "puppeteer";
import { afterAll, beforeAll, describe, expect, it, vi } from "vitest";
import { effSource as config } from "@/config/sources/eff.js";
import { createBrowser, setupPage } from "@/crawlers/browser";
import { createContentPageExtractor } from "@/crawlers/extractors/ContentPageExtractor";
import { createListingPageExtractor } from "@/crawlers/extractors/ListingPageExtractor";
import { navigateToNextPage } from "@/crawlers/handlers/PaginationHandler";

const ifDescribe = process.env.INT_TEST === "true" ? describe : describe.skip;

ifDescribe("Electronics Foundation integration tests", () => {
	let browser: PuppeteerBrowser;
	vi.setConfig({ testTimeout: 60000 });

	beforeAll(async () => {
		browser = await createBrowser();
	});

	afterAll(async () => {
		await browser.close();
	});

	it("should crawl EFF listing page", async () => {
		const page = await setupPage(browser, config.listing.url);
		const extractor = createListingPageExtractor();
		const result = await extractor.extractItemsFromPage(page, config, [], 0);
		expect(result.items.length).toBeGreaterThan(0);
		expect(result.items.every((item) => !!item.title)).toBeTruthy();
		expect(result.items.every((item) => !!item.url)).toBeTruthy();
		expect(result.items.every((item) => !!item.publishedDate)).toBeTruthy();
		expect(result.items.every((item) => !!item.content)).toBeTruthy();
	});

	it("should crawl to next EFF listing page", async () => {
		const page = await setupPage(browser, config.listing.url);
		expect(await navigateToNextPage(page, config)).toBeTruthy();
	});

	it("should crawl multiple EFF content pages", async () => {
		const testCases = [
			{
				url: "https://www.eff.org/deeplinks/2025/08/eff-awards-spotlight-software-freedom-law-center-india",
				expectedTitle:
					"EFF Awards Spotlight ✨ Software Freedom Law Center, India",
				expectedContent:
					"In 1992 EFF presented our very first awards recognizing key leaders and organizations advancing innovation and championing civil liberties and human rights online. Now in 2025 we're continuing to celebrate the accomplishments of people working toward a better future for everyone with the EFF Awards!All are invited to attend the EFF Awards on Wednesday, September 10 at the San Francisco Design Center. Whether you're an activist, an EFF supporter, a student interested in cyberlaw, or someone who wants to munch on a strolling dinner with other likeminded individuals, anyone can enjoy the ceremony!If you're not able to make it, we'll also be hosting a livestream of the event on Friday, September 12 at 12:00 PM PT. The event will also be recorded, and posted to YouTube and the Internet Archive after the livestream.We are honored to present the three winners of this year's EFF Awards: Just Futures Law, Erie Meyer, and Software Freedom Law Center, India. But, before we kick off the ceremony next week, let's take a closer look at each of the honorees. And last, but certainly not least—Software Freedom Law Center, India, winner of the EFF Award for Defending Digital Freedoms:Software Freedom Law Center, India is a donor-supported legal services organization based in India that brings together lawyers, policy analysts, students, and technologists to protect freedom in the digital world. It promotes innovation and open access to knowledge by helping developers make great free and open-source software, protects privacy and civil liberties for Indians by educating and providing free legal advice, and helps policymakers make informed and just decisions about use of technology. SFLC.IN tracks and participates in litigation, AI regulations, and free speech issues that are defining Indian technology. It also tracks internet shutdowns and censorship incidents across India, provides digital security training, and has launched the Digital Defenders Network, a pan-Indian network of lawyers committed to protecting digital rights. It has conducted landmark litigation cases, petitioned the government of India on freedom of expression and internet issues, and campaigned for WhatsApp and Facebook to fix a feature of their platform that has been used to harass women in India. We're excited to celebrate SFLC.IN and the other EFF Award winners in person in San Francisco on September 10! We hope that you'll join us there.Thank you to Fastly, DuckDuckGo, Corellium, and No Starch Press for their year-round support of EFF's mission.Want to show your team’s support for EFF? Sponsorships ensure we can continue hosting events like this to build community among digital rights supporters. Please visit eff.org/thanks or contact tierney@eff.org for more information on corporate giving and sponsorships.EFF is dedicated to a harassment-free experience for everyone, and all participants are encouraged to view our full Event Expectations.Questions? Email us at events@eff.org.",
			},
			{
				url: "https://www.eff.org/deeplinks/2015/07/eff-commerce-department-we-must-revise-overbroad-export-control-proposal",
				expectedTitle:
					"EFF to Commerce Department: We Must Revise Overbroad Export Control Proposal",
				expectedContent:
					'EFF has long advocated for greater vigilance over the potential sale of specially-developed surveillance tools to oppressive regimes that use technology to commit human rights abuses. We want those countries to be held legally accountable for such conduct, and have rallied tech companies to take steps to prevent their products and services from being used for censorship and/or to target and harm activists. But when we saw the proposal of the Bureau of Industry and Security (BIS) at the U.S. Commerce Department for implementation of the latest changes to the Wassenaar Arrangement export controls—which would require export licenses for the sale of certain surveillance technology—we saw that the BIS had drafted a vague, overbroad, and contradictory set of rules that have the potential to chill legitimate research into security vulnerabilities that will keep data and devices secure from attacks. EFF joined a coalition of six advocacy organizations, including Human Rights Watch and the Center for Democracy & Technology, to submit comments this week to BIS urging the government to narrow the rules to focus exclusively on technology designed for government end users or for military or law enforcement end uses, while ensuring that the general-purpose tools we all depend on for our security aren’t swept up in overbroad regulations. The goal should be to make it tougher for repressive regimes and criminals to get their hands on and use purpose-built surveillance technologies to target activists and interrupt the free flow of information, without harming distribution of penetration testing and network security tools, we told the Commerce Department. The Wassenaar Arrangement is a multi-national agreement intended to control the export of certain "dual-use" technologies. It\'s a voluntary agreement among 41 participating states that mostly regulates the export of guns, other weapons (such as landmines), and their components (such as fissile material). In December 2013, the list of controlled technologies was amended to include surveillance systems for the first time, in response to reports linking exports of Western surveillance technologies to human rights abuses in countries such as Bahrain and the UAE, Turkmenistan, and Libya. In May BIS published its proposed implementation of the 2013 changes, and we were troubled by the vague and overbroad language and definitions of intrusion software that appeared to sweep up many of the common and perfectly legitimate tools used in security research. BIS last month released a FAQ that addressed some of our concerns about whether the proposed rules incorporate exemptions for technology in the public domain. But the FAQ failed to ease our concerns about whether, under the proposal, companies would be required to share their zero-day exploits with the government in order to get a license. We have urged the Commerce Department in our joint comment to avoid ambiguity and clearly spell out that cybersecurity software and technology generally available to the public are exempt from licensing and tailor the licensing process specifically to human rights concerns. “We believe it’s possible for the government to craft a final rule that is narrowly tailored to address the human rights concerns raised by the spread of surveillance technologies without adversely affecting a variety of additional technologies, including important research and testing tools,” we told the government. EFF submitted a separate comment of its own urging the Commerce Department to take bold action and eliminate encryption items from export regulation before proceeding with implementation of Wassenaar and revise the proposed rules and reopen a second public comment period. We also strongly encourage the agency to carefully consider constitutional due process and First Amendment implications of any vaguely-worded agreement that would act as an illegal prior restraint on the spread of knowledge',
			},
			{
				url: "https://www.eff.org/press/archives/2008/04/21-44",
				expectedTitle:
					"Mathematician challenges U.S. lid on encryption software",
				expectedContent:
					"By Rory J. O'Connor Mercury News Staff Writer A Berkeley mathematician sued the State Department Tuesday, in a case designed to challenge the government's designation of encryption software as a ``munition'' subject to extensive export controls. The policy has prevented even the publication of some schemes for individuals to protect their computer data or electronic mail from eavesdropping. Distributing information about many encryption schemes without government approval could be a criminal act punishable by 10 years in prison and fines of $1 million or more. Daniel Bernstein, a Ph.D. candidate at the University of California, decided to sue after the government told him 18 months ago he would have to register as an arms dealer under the International Traffic in Arms Regulation if he wanted to publicize an encryption program he had developed, according to his attorney, Cindy Cohn of McGlashan and Sarrail in San Mateo. After reading electronic postings from other cryptographers, Bernstein applied for permission to publish the program and a paper describing how it works. The government favors a strict policy because computerized methods for sending coded messages have made the job of intelligence gathering far more difficult. Intelligence agencies have expressed concern that terrorists, drug traffickers and hostile foreign governments could obtain such string [sic] encryption software and communicate via undecipherable coded messages. Some of the exhibits filed with the lawsuit that outline Bernstein's scheme had to be sealed from public view, Cohn said. Attorneys were barred from discussing them because making them public could be construed as a criminal act. Civil liberties groups with computer connections have long opposed the government's practice, saying it stifles freedom of expression.",
			},
			{
				url: "https://www.eff.org/press/releases/trailblazing-tech-scholar-danah-boyd-groundbreaking-cyberpunk-author-william-gibson",
				expectedTitle:
					"Trailblazing Tech Scholar danah boyd, Groundbreaking Cyberpunk Author William Gibson, and Influential Surveillance Fighters Oakland Privacy Win EFF’s Pioneer Awards",
				expectedContent:
					"San Francisco – The Electronic Frontier Foundation (EFF) is honored to announce the winners of its 2019 Pioneer Awards: trailblazing tech scholar danah boyd, groundbreaking cyberpunk author William Gibson, and the influential surveillance-fighting group Oakland Privacy. The ceremony will be held September 12th in San Francisco. The keynote speaker for this year’s awards will be “Savage Builds” and Tested.com star—and all-around advocate for makers—Adam Savage. Tickets for the Pioneer Awards are $65 for current EFF members, or $75 for non-members. danah boyd has consistently been one of the world’s smartest researchers, thinkers, and writers about how technology impacts society, especially for teens and young people. Currently, boyd is focused on detecting and mitigating vulnerabilities in sociotechnical systems. To better understand these vulnerabilities, boyd has been examining the challenges surrounding the 2020 U.S. Census. In 2013, boyd created Data & Society, an independent nonprofit research institute that is committed to identifying thorny problems at the intersection of technology, culture, and community, and advances understanding of the implications of data technologies and automation. danah’s most recent books—“It’s Complicated: The Social Lives of Networked Teens” and “Participatory Culture in a Networked Age”—examine the intersection of everyday life and social media, and have helped families around the world navigate technologies like Facebook, Twitter, YouTube, and Instagram. In addition to her work as a partner researcher at Data & Society, boyd is also Principal Researcher at Microsoft Research and a Visiting Professor at New York University. William Gibson coined the term “cyberspace.” Neuromancer, his first novel, won the Hugo Award, the Nebula Award, and the Philip K. Dick Award in 1984, and is a groundbreaking portrayal of an unforgiving high-tech future with heroes that are thoroughly flawed human beings who nonetheless resist corporate power by seizing the means of computation. His work presents an incisive look at how technology shapes identity, with sharp, prescient depictions of everything from reality TV to wearable computers. Gibson's canon includes such New York Times bestsellers as the Sprawl trilogy, the Bridge trilogy, the Blue Ant trilogy, and The Peripheral. Gibson’s newest novel, Agency, will be published in January of 2020. Oakland Privacy is the group behind many influential anti-surveillance fights in Oakland, California and beyond. Oakland Privacy was born in 2013 when activists discovered a Homeland Security project called the Domain Awareness Center (DAC). DAC was meant to be an Oakland-wide surveillance gauntlet—with cameras, microphones, license plate readers—and a local data center to put it all together. But after Oakland Privacy led a ten-month campaign of opposition, the DAC was finally cancelled. Later, Oakland Privacy was one of the primary organizations behind the Oakland City Council’s creation of the first municipal privacy commission in the country, and then continued to be instrumental in bolstering opposition to surveillance around the San Francisco Bay Area and across the United States. For example, Oakland Privacy helped develop a comprehensive surveillance transparency regulatory law mandating use policies, civil rights impact reports, and annual audits, and pushed for its passage in multiple jurisdictions. The model is now in use in three Bay Area cities and other jurisdictions like Seattle, Nashville, and Cambridge, Massachusetts. Most recently, Oakland Privacy successfully worked to ban facial recognition in San Francisco and Oakland—two of the three cities in the country to enact such a ban. The Pioneer Award winners will be awarded a “Barlow,” a statuette named after EFF’s late co-founder John Perry Barlow and the indelible mark he left on digital rights. “John Perry Barlow knew that you had to visualize the future of technology—both the promise and the perils—in order to create the world we want. All of our winners this year have done just that,” said EFF Executive Director Cindy Cohn. “I’m so proud to be honoring these bold thinkers and brave activists.” Awarded every year since 1992, EFF’s Pioneer Awards recognize the leaders who are extending freedom and innovation on the electronic frontier. Previous honorees have included Vint Cerf, Mitchell Baker and the Mozilla Foundation, Aaron Swartz, and Chelsea Manning. Sponsors of the 2019 Pioneer Awards include Dropbox, O'Reilly Media, Matthew Prince, Medium, Ridder, Costa & Johnstone LLP, and Ron Reed. For tickets and event details:https://supporters.eff.org/civicrm/event/register?id=230&reset=1For more on the Pioneer Awards:https://www.eff.org/awards/pioneer/2019 Contact: Press Contact: Rebecca Jeschke",
			},
			{
				url: "https://www.eff.org/deeplinks/2010/03/wiring-big-brother-machine",
				expectedTitle: "Wiring Up The Big Brother Machine... And Fighting It",
				expectedContent:
					"Here's a movie pitch: One lone telecommunications technician, going about his ordinary daily work in San Francisco, begins to realize things aren't quite what they seem. There's a \"secret room\" downstairs, and ordinary employees aren't allowed to enter it. Coworkers — almost casually! — remark that a government spy agency is involved, that similar facilities are being built across the country, that some of them are stamped with the government's ominous eye-and-pyramid \"Total Information Awareness\" logo. Soon, the plot thickens. Mundane technical procedures produce startling revelations. He stumbles on a document that suggests the room contains a supercomputer designed to data-mine phone calls and Internet traffic. And, indeed, he soon realizes that the room is sucking up copies of electronic communications from millions of random Americans. All this in the early 2000s, when \"the political atmosphere in the country after 9/11 had a witchhunt feel to it, and even modest criticism of the administration was getting painted as disloyalty or worse.\" What happens to our hero when he finally decides to go public? Even though I'd heard Mark Klein's story before, I'd never considered just how frightening and surreal his experience must have been. His new memoir reads like something out of a kafka-esque sci-fi spy thriller — except that it all really happened right here in the USA, just a few years ago. For instance, when Klein shares his evidence with an eager reporter for the Los Angeles Times, at first he's told the story will be ground-breaking and \"a big front-page spread.\" Yet, the story languishes for weeks. Klein writes: On Feb 11 (2006), I got a call from Joe Menn, the Los Angeles Times reporter, who told me that their \"top guy\" was going to have a meeting with the Director of National Intelligence John Negroponte himself about this story over the weekend. I nearly fell down in shock — they were actually negotiating with the government on whether to publish!... More importantly, this meant Negroponte knew about my documents — and me. Indeed, as ABC's Nightline revealed much later, both Negroponte and National Security Agency Director Michael Hayden pressured the LA Times to kill the story. And when Klein told his story to CBS's 60 Minutes, they too eventually killed the story without explanation. In the end, of course, Klein's evidence became the backbone of EFF's lawsuit against AT&T for their complicity in illegal government spying. Originally ignored by Senators and newspapers alike, his evidence was ultimately so damning that it could only be defeated by an unprecedented \"telco immunity\" law pushed by the Bush White House and passed by the US Congress amidst a massive public controversy. EFF then relied on Klein's evidence for a case against the government, which has been met with fierce resistance by the Obama Administration. Klein's journey, from quiet cubicle technician to personal enemy of the White House and Pentagon, is amazing, moving and eerie. His story, \"Wiring Up The Big Brother Machine... And Fighting It,\" is on sale now.",
			},
		];

		await Promise.all(
			testCases.map(async (testCase) => {
				const page = await setupPage(browser, testCase.url);
				const extractor = createContentPageExtractor();
				const result = await extractor.extractFromContentPage(
					page,
					testCase.url,
					config,
				);

				expect(result.contentData.title).toEqual(testCase.expectedTitle);
				expect(result.contentData.content).toEqual(testCase.expectedContent);
				expect(result.errors.length).toBe(0);

				await page.close();
			}),
		);
	});
});
