import type { Browser as PuppeteerBrowser } from "puppeteer";
import { afterAll, beforeAll, describe, expect, it, vi } from "vitest";
import { fpfSource as config } from "@/config/sources/fpf.js";
import { createBrowser, setupPage } from "@/crawlers/browser";
import { createContentPageExtractor } from "@/crawlers/extractors/ContentPageExtractor";
import { createListingPageExtractor } from "@/crawlers/extractors/ListingPageExtractor";
import { navigateToNextPage } from "@/crawlers/handlers/PaginationHandler";

const ifDescribe = process.env.INT_TEST === "true" ? describe : describe.skip;

ifDescribe("Freedom Press integration tests", () => {
	let browser: PuppeteerBrowser;
	vi.setConfig({ testTimeout: 60000 });

	beforeAll(async () => {
		browser = await createBrowser();
	});

	afterAll(async () => {
		await browser.close();
	});

	it("should crawl FPF listing page", async () => {
		const page = await setupPage(browser, config.listing.url);
		const extractor = createListingPageExtractor();
		const result = await extractor.extractItemsFromPage(page, config, [], 0);
		expect(result.items.length).toBeGreaterThan(0);
		expect(result.items.every((item) => !!item.title)).toBeTruthy();
		expect(result.items.every((item) => !!item.url)).toBeTruthy();
		expect(result.items.every((item) => !!item.publishedDate)).toBeTruthy();
		expect(result.items.every((item) => !!item.content)).toBeTruthy();
	});

	it("should crawl to next FPF listing page", async () => {
		const page = await setupPage(browser, config.listing.url);
		expect(await navigateToNextPage(page, config)).toBeTruthy();
	});

	it("should crawl multiple FPF content pages", async () => {
		const testCases = [
			{
				url: "https://freedom.press/issues/a-massive-failure-in-kansas-two-years-since-the-marion-county-record-raid/",
				expectedTitle:
					"A ‘massive failure’ in Kansas: Two years since the Marion County Record raid",
				expectedContent:
					"The police raid of the Marion County Record’s newsroom on Aug. 11, 2023, shocked the country but proved to be just one of a series of alarming attacks on local journalism that year. It was also a preview of how lawless and incompetent governments can use strained constructions of the law as pretext to retaliate against journalists they dislike, as we now see not only in small-town America but at the federal level. As the death of Record co-owner Joan Meyer the next day tragically proved, by the time justice takes its course — if it ever does — the damage has often already been done.We asked investigative journalist Jessica McMaster to reflect on her award-winning coverage of the raid for KSHB-TV in Kansas City, Missouri. The interview is below. You can also read about or watch our discussion with Record publisher Eric Meyer earlier this year. On a Friday afternoon in 2023, news broke of a police raid of the Marion County Record newsroom and its publisher Eric Meyer’s home. Did you realize right away that this needed to be not just a statewide story but a national one?I realized right away this was a big story. Once the news broke that Joan Meyer died, I knew we had to go to Marion — the backlash was immediate and the responses were coming in from across the country. Over the course of many months, it became clear that the raid wasn’t a random instance of police overresponding to a citizen complaint. Details began to emerge about local officials, including the police chief, Gideon Cody, and their conduct before, during, and after the raid — even before coming to Marion. Plenty of great local journalists did amazing work covering the story, but you seemed to get a large share of the big scoops. Without divulging any confidences, how were you able to pull it off, especially being based in Kansas City, not particularly close to Marion? I worked a lot of hours. In the beginning, we stayed overnight in Marion. After that, it was a lot of driving back and forth, while taking calls from sources at all hours of the night. I’d been a journalist long enough to know that a story this big doesn’t die down for a few weeks. We made the commitment to drive the five-hour round trip daily. I didn’t always know what our angle would be, but I knew I’d find it. “If journalists are not willing to report on the ongoing attacks against the free press, who will?” Jessica McMaster Talk about the level of transparency — or lack thereof — that you encountered from government officials, both in Marion and statewide, during your reporting on the raid. What were some of the challenges you needed to overcome, in terms of secrecy and accessing information that was of public interest?Gideon Cody wasn’t talking. The county attorney wasn’t talking. The Kansas Bureau of Investigation was saying very little. Almost immediately, it had the appearance that everyone involved in this was covering their own tail — and of course they were. This was a huge mess. We leaned on the gift of open records laws to get most of our information. Getting emails and text messages helped piece the parts of the story together that those in power wanted to remain a secret. We knew they’d try and block us — we were prepared to fight back. There were times when we had to get our attorneys involved when information was being withheld. On a story like this, the details don’t reveal the truth all at once. It trickles out over time. It’s always fun to look back and see how it all comes together — one information request, or leak, at a time. At Freedom of the Press Foundation (FPF), we were glued to your X feed for real-time updates. We probably weren’t the only ones. Can you talk about the challenge of breaking news on social media while also investigating the bigger stories?This is one of my favorite parts about covering a big story — connecting with people in real time. I had people from other countries sending me emails and tweeting to me that they were following me for updates. I was not asked to use social media in real time by my employer — it’s just something I’d become accustomed to doing since early on in my career. With Marion, we were getting updates constantly — social media made it easy to get that information out quickly. I don’t see using social media as a challenge — I think it’s a tool to connect with our followers more authentically and bring them along on the journey with us. Of course, if I have to get my broadcast script in urgently, or I have to be on camera within the next few minutes, I’ll take a break from providing live updates and come back to it once I’m done. Were there any stories you were able to break while covering the raid that you felt were particularly important to the public’s understanding of what went on?We broke so many stories over the first couple of months. I remember driving to Marion during that first week of coverage. I didn’t know what the story would be on this particular day. It was our plan to find the story once we got there. About an hour into our trip, while driving past a cornfield, my cellphone rings and it’s the attorney for Marion County Record. He tips me off that the county attorney has revoked the search warrants. He gave me a two-minute head start before he planned to tell all the other reporters. This was arguably the biggest break in the case — it’s the first time officials publicly admitted the raids shouldn’t have happened. This squashed any doubts of wrongdoing on behalf of the newspaper — and people, especially in Marion — did have their doubts. So, of course, I’m scrambling to get this information out there. Minutes after I broke the news on X, the county attorney sent a press release to all newsrooms with his statement on revoking the warrants. “It’s hard for a lot of us to grasp that so many people, in positions of power, failed in such spectacular fashion to do their jobs.” Jessica McMaster What insights did you come away with about the state of press freedom in Kansas and in the United States? This was a massive failure by several people within the justice system. I think that’s what’s so shocking about this entire thing — most of us assume a police chief would understand press freedom laws. If a police chief doesn’t, we’d assume a county attorney would. If a county attorney doesn’t, we’d assume a district judge would. If no one understands these laws — surely someone will look it up. The amount of layers Gideon Cody’s attack on the newspaper survived is astonishing. What did all these people, who are supposed to understand the law, think the response would be? I think it’s hard for a lot of us to grasp that so many people, in positions of power, failed in such spectacular fashion to do their jobs.Do you think the raid had an ongoing chilling effect on journalism? I think the chilling effect comes from a culmination of attacks that have been launched against the free press over the past several years. We’ve seen this play out in other instances, during protests for example, where police assault or arrest journalists for doing their jobs. I think Marion was another example of that. Despite your award-winning work on the raid and all the other great work you’ve done, less than two years after the raid, your position at KSHB-TV, Kansas City’s NBC affiliate, was eliminated. What does that say about the state of the news industry and whether local investigative reporting is valued these days?The company I worked for always valued investigative journalism — it’s why I stayed in my position for a decade. I think what we’re seeing is that many local newsrooms are becoming more and more risk averse. I personally felt this shift over the past few years. When newsrooms operate from a place of fear, it’s very difficult for reporters to do their job, especially investigative reporters who, by nature, do more high-risk, accountability-focused stories. What’s next for you? I saw that your X post about the layoff said your time as an investigative journalist was coming to an end. Are you done with journalism or are you going to look for a way back in? And why? I love journalism. I believe in its purpose. I believe in its power. We need solid journalists who aren’t afraid to hold the powerful accountable. That said, I don’t see myself stepping back into a newsroom. At least not anytime soon. I took the summer off to focus on my kids and reflect on what I want to do next, which has been such a gift. I plan to keep writing and creating content for something I believe in. Journalists often feel like covering press freedom stories is difficult, because they’re making themselves the story or because their objectivity will be questioned, for example. What do you say to that, and what’s your advice to journalists and editors wondering whether it’s a good idea to report on press freedom violations? Stick to the facts. That’s my advice. While I didn’t initially know why police raided the newspaper, I knew this was fundamentally wrong. I knew police should’ve served a subpoena, as opposed to busting down the doors. I knew the free press has protections, both locally and federally. All of that gave me grounds to cover this story. It can be uncomfortable reporting on something so closely tied to our personal lives — but if journalists are not willing to report on the ongoing attacks against the free press, who will?",
			},
			{
				url: "https://freedom.press/issues/how-aaron-swartz-fought-for-government-transparency/",
				expectedTitle: "How Aaron Swartz Fought For Government Transparency",
				expectedContent:
					'"Transparency can be a powerful thing, but not in isolation. So, let’s stop passing the buck by saying our job is just to get the data out there and it’s other people’s job to figure out how to use it. Let’s decide that our job is to fight for good in the world." —Aaron Swartz The brilliant hacker and activist Aaron Swartz, who tragically died last week at the age of 26, is perhaps best known for his work on the early days of Reddit, for helping lead the fight against SOPA, and for helping craft groundbreaking innovations like RSS and Creative Commons. But what drove all those achievements was a relentless curiosity and a passionate mind, and what\'s less known is how committed he was to government transparency and openness. "Hi. I live in Cambridge and file a lot of FOIA/PA requests," Aaron emailed me, by way of introduction, in the Fall of 2010. I had just founded MuckRock News, an open government organization that helps the public file Freedom of Information Act requests, which we then report on when we receive results. "Any chance I can get a MuckRock account?" He could: He was officially MuckRock user 70, though probably one of the first dozen to actually file a request. And he used it regularly, with eyes open for the topical and mundane, the personal and political. He was among the first to request photos from the killing of Osama Bin Laden. He requested information on how the United States Secret Service requested and accessed Google\'s data. He filed requests with the U.S. Mint and about Bradley Manning. The requests he appeared most interested in appeared to be records related to ICE domain seizures. Mike Masnick at TechDirt wrote about the results: The redactions were so severe as to make the documents almost "useless". At the time of his death, I was working with Aaron on appealing the redactions and fee assessments. Aaron also filed several requests relating to the federal investigations into himself. The Department of Justice claimed it had no responsive documents in relation to his attempt to "open" the PACER database, the tax-supported database of American case law, which nonetheless operates on a fee-for-service basis. In 2009, Aaron took advantage of PACER giving libraries free access to its service by downloading approximately 20% of the database. The FBI never pressed charges (because he had broken no law) but the Executive Office for United States Attorneys withheld in full 72 pages on him regarding that same case. For many of these requests, Aaron would literally wait years for a response, only to receive cryptic rejections or no response at all. For every time he raised the ire of federal investigators, and ultimately prosecutors, he had, indeed, taken the proscribed path dozens or hundreds of times. If Aaron\'s methods and aims in freeing information were "radical," then they were reactions to deep-rooted, systematic failures that often demanded radical responses. Today, as a small way to remember Aaron, and to help continue his legacy of agitation, MuckRock will offer free requests, for everyone. Let us know what information you would like to see free, and how Aaron impacted you. Together, let\'s continue to fight for good in the world. Michael Morisy is the founder of MuckRock. He can be reached at Michael@MuckRock.com.',
			},
			{
				url: "https://freedom.press/issues/new-election-blog-catalogs-media-suppression-by-candidates-campaigns/",
				expectedTitle:
					"New election blog catalogs media suppression by candidates, campaigns",
				expectedContent:
					"How a candidate treats the press while on the campaign trail is usually a good indicator of how they’ll treat them while in office. And as the 2024 general election nears, our U.S Press Freedom Tracker is making a public record of just that — cataloging statements against the press by candidates for federal office and efforts by them to diminish the media’s newsgathering capabilities.It was certainly true for Donald Trump. From the time he declared his first candidacy for president in 2015 through to his account suspension on X (then Twitter) in 2021, Trump tweeted negatively about the press an average of more than once a day over those 5 ½ years, according to the Tracker. And this year, as a candidate and presumptive presidential Republican nominee, he’s doing it again. His campaign, for example, barred an NBC reporter from attending an event in New Hampshire in late January, but did not provide any explanation why. And this year, as a candidate and presumptive presidential Republican nominee, [Trump's] doing it again. Only five days earlier, the former president said that CNN and MSNBC should “have their licenses or whatever they have taken away,” after the networks only aired a portion of his Iowa caucus victory speech.Other candidates use similar playbooks. U.S. Rep. Mike Lawler, a Republican running for reelection in a tossup district in New York’s Hudson Valley, recently ended a monthslong effort to restrict media access to his public town hall events. Vivek Ramaswamy, who’s now suspended his Republican presidential bid, used his opening statement at a November GOP debate to target NBC News anchor Kristen Welker and the “corrupt media establishment,” while falsely claiming the media rigged the 2020 election.From now until Election Day, our Tracker team will continue to document and highlight relevant sidelining of, attacks on, or outright barring of press from major campaign events across the United States.Follow the Tracker’s Election Blog here.",
			},
			{
				url: "https://freedom.press/issues/prosecutor-puts-doge-ahead-of-first-amendment/",
				expectedTitle: "Prosecutor puts DOGE ahead of First Amendment",
				expectedContent:
					"Dear Friend of Press Freedom,We’re taking action against alarming attempts to stifle the press from state and federal adversaries. And don’t forget: we have tools and advice for how to safely share leaks with the press. Read the latest here. Prosecutor puts DOGE ahead of First AmendmentFreedom of the Press Foundation (FPF) and a coalition of rights groups sent a letter to interim U.S. Attorney for the District of Columbia Edward R. Martin Jr. demanding he clarify statements suggesting he would prosecute critics of Elon Musk and his Department of Government Efficiency. “There’s nothing more central to the First Amendment than the press and public’s right to criticize those carrying out controversial government work, harshly and by name,” we said in a statement. “A sitting U.S. attorney threatening to prosecute this constitutionally protected conduct is highly alarming — even un-American.” Read the statement and letter here.Judges: Stop facilitating Trump’s extortionate settlements Companies like ABC and Meta aren’t the only ones to blame for capitulating to President Donald Trump by settling his SLAPP suits. So are the judges who bless these extortionate agreements. Judges don’t have to rubber-stamp settlements when there are glaring indicators of impropriety.“It violates public policy — embodied by the First Amendment — for the courts to facilitate bribes paid by media publishers to presidents,” writes FPF Advocacy Director Seth Stern. “All of this is out in the open, and judges should not bury their heads in the sand when asked to sign off on it.” Read more here. Freelance journalists are journalists The Utah Legislature recently changed its press credential rules to exclude “blogs, independent, or other freelance journalists,” and one journalist alleges in a new lawsuit that the change was made to retaliate against him specifically.The timing seems to support that claim, but even if he’s wrong about the legislature’s motives, the new rules show a troubling disregard for press freedom. “The Legislature should be celebrating the enhanced coverage that independent journalists bring to the statehouse and finding ways to accommodate them,” writes FPF Senior Advocacy Adviser Caitlin Vogus in The Salt Lake Tribune. USAID’s records must survive — even if the agency doesn’tIn a dubious legal move, the Trump administration is trying to shutter the U.S. Agency for International Development. But the widespread coverage of USAID’s future misses something important: the status of its records and the processing of its Freedom of Information Act requests.These should not be secondary concerns. Our Daniel Ellsberg Chair on Government Secrecy Lauren Harper has the full story. And for more secrecy news, subscribe to Harper’s newsletter, The Classifieds.What we’re readingThis is not a moment to settle with Trump (The New York Times). “Courage is contagious, but cowardice and cravenness can be, too. Soon it may be unusual and even more perilous for a news organization to protest when it is accused by the president of reportorial recklessness, however outlandish the charge might be,” Jameel Jaffer writes.FCC launches investigation into KCBS after host reveals details of ICE agents in area (Barrett Media). The Federal Communications Commission cannot deem constitutionally protected journalism outside the \"public interest\" whenever it wants to censor the press. It’s an even more slippery slope with an unprincipled partisan hack like Brendan Carr in charge.Judge tosses SF lawsuit that spurred Streisand Effect for tech exec’s arrest (Gazetteer San Francisco). While news giants with armies of expensive lawyers capitulate to the powerful, independent journalists represented by rights organizations and law professors fight back and win. Congratulations to Jack Poulson.Protecting free speech in Texas: We need to stop SB 336 (Electronic Frontier Foundation). Texas needs a strong anti-SLAPP law. If you live there, call or email your state representatives or the senators on the Senate Committee on State Affairs today and urge them to vote “no” on SB 336. It would weaken protections against anti-speech lawsuits by billionaires and politicians.Justice Dept. says it will not bring charges in investigation of Project Veritas (The New York Times). The theory that publishers could be prosecuted for possessing or transporting documents their sources stole was constitutionally problematic. It's good this case won't set a bad First Amendment precedent, although we very much doubt that's why the Trump DOJ dropped it.CIA analyst’s plea deal adds further intrigue to Espionage Act prosecution (The Dissenter). Plea deals requiring defendants to let the intelligence community supervise their communications with the press seem rather problematic under the First Amendment, no matter who the defendant is. Fox sues LinkedIn co-founder Hoffman for litigation funding info (Bloomberg Law). We’re for full transparency when it comes to billionaires funding defamation cases against media outlets, no matter who the billionaire is or who the media outlet is.How to share sensitive leaks with the pressWe’re just going to leave this one here for the foreseeable future.",
			},
		];

		await Promise.all(
			testCases.map(async (testCase) => {
				const page = await setupPage(browser, testCase.url);
				const extractor = createContentPageExtractor();
				const result = await extractor.extractFromContentPage(
					page,
					testCase.url,
					config,
				);

				expect(result.contentData.title).toEqual(testCase.expectedTitle);
				expect(result.contentData.content).toEqual(testCase.expectedContent);
				expect(result.errors.length).toBe(0);

				await page.close();
			}),
		);
	});
});
